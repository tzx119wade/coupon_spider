<!DOCTYPE html>
{% load staticfiles %}
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="yes" name="apple-touch-fullscreen">
  <meta content="telephone=no,email=no" name="format-detection">
  <meta name="apple-mobile-web-app-title" content="ç³–çˆ¸çˆ±çœé’±">
  <link rel="apple-touch-icon-precomposed" href="{% static 'img/icon-144.png' %}">
  <link href="{% static 'img/icon-144.png' %}" rel="shortcut icon" type="image/x-icon">
	<link rel="stylesheet" href="{% static 'css/search.css' %}">
	<script src="http://g.tbcdn.cn/mtb/lib-flexible/0.3.4/??flexible_css.js,flexible.js"></script>
	<script src="{% static 'js/reqwest.js' %}"></script>
  	<script src="{% static 'js/js.cookie.js' %}"></script>
  	<script src="{% static 'js/jquery.js' %}"></script>
  	<script src="{% static 'js/vue1.js' %}"></script>
	<title>æœåˆ¸åŠ©æ‰‹</title>
</head>
{% verbatim %}
<body id="app">
	<div class="header_box">
		<header class="detail-top">
			<h2>æœåˆ¸å°åŠ©æ‰‹</h2>
			<a href="http://www.heydaily.info:8000">
				<i class="icon_back_icons"></i>
				è¿”å›
			</a>
		</header>
	</div>

	<div class="result_contain_page">
		<div class="result" id="result">
			<div class="result-box">
				<div class="search-box">
					<form class="search_info" v-on:submit.prevent="click_search_button()" action="#">
						<i class="search_icon"></i>
						<input type="search" placeholder="è¾“å…¥ä½ æƒ³è¦æ‰¾åˆ°å®è´" v-model="search_keyword" id="search-input">
					</form>
					<div class="go-search" v-on:click="click_search_button()">æ‰¾åˆ¸</div>
				</div>
			</div>
		</div>

		<div class="tickets">
			<div class="tickets-top">
				<span class="fl">å¤§å®¶éƒ½åœ¨æ‰¾</span>
			</div>
			<ul class="tickets-list">
      <template v-for="item in recommend_keyword">
				<li v-on:click.prevent="recommend_button_click(item.name)">
					<a href="">{{ item.name }}</a>
				</li>
      </template>
			</ul>
		</div>
	</div>

	<div class="item-container">
		<ul class="result-list">
		<template v-for="item in items">
			<li>
				<a v-bind:href="item.url">
					<img src="http://www.heydaily.info:8000/static/img/default_img.png" class="result-img" v-bind:id="item.numiid" v-bind:data-src="item.img">
					<div class="result-info">
						<p class="result-title">{{ item.title }}</p>
						<div class="result-tm">
							<i class="icon-tm-tao" v-if="item.usertype == 0"></i>
							<i class="icon-tm-mao" v-if="item.usertype == 1"></i>
							<span class="result-tm-info">åŒ…é‚®</span>
						</div>
						<p class="result-price">
							Â¥
							<span class="price-value">{{ item.price }}</span>
							<span class="price-other">åˆ¸åä»·
							</span>
						</p>
						<div class="result-bottom">
							<span class="ticket-price">é¢†{{ item.quota }}å…ƒåˆ¸</span>
							<span class="ticket-count">{{ item.volume }}äººé¢†å–</span>
						</div>
					</div>
				</a>
			</li>
		</template>
		</ul>
		<div class="no-more-tip" v-if="request_api_wrong">
					{{ msg }}
		</div>

		<div class="spinner" v-if="call_api_right_now">
        	<div class="rect1"></div>
        	<div class="rect2"></div>
        	<div class="rect3"></div>
        	<div class="rect4"></div>
    	</div>
	</div>

	
	<script>

	  	// others 
  		String.prototype.format = function () {
    		var i = 0, args = arguments;
    		return this.replace(/{}/g, function () {
      		return typeof args[i] != 'undefined' ? args[i++] : '';
        	});
  		};

  

  		var app = new Vue({
  			el:'#app',
  			data:{
  				next_page_num:0,
  				items:[],
  				search_keyword:'',
  				load_imgs:[],
  				aleady_load_imgs:[],
  				call_api_right_now:false,
  				request_api_wrong:false,
  				msg:'',
          recommend_keyword:[
                      {name:'çŸ­è¢–'},
                      {name:'è¡£æ¶'},
                      {name:'æ‰‹æœºå£³'},
                      {name:'æ¦¨æ±æœº'},
                      {name:'USBç”µé£æ‰‡'},
                      {name:'é˜²æ™’ä¹³'},
                      {name:'ç‰™è†'},
                      {name:'å©´å„¿åºŠ'},
                      {name:'è…®çº¢'},
                      {name:'èƒŒå¿ƒ'},
                      {name:'å¤ªé˜³é•œ'},
                ],
  			},
  			methods:{
  				// è¯·æ±‚APIæ¥å£
  				get_search_data:function(){
  					var api_url = 'http://www.heydaily.info:8000/api/search/{}/{}/'.format(this.search_keyword, this.next_page_num);
  					var self = this;

  					reqwest({
  						url:api_url,
  						method:'get',
  						type:'json',
  						headers :{'X-CSRFToken': Cookies.get('csrftoken')},
  						success:function(resp){
  							self.call_api_right_now = false;
  							self.next_page_num++;
  							for (var i = 0;i < resp.length; i++){
  								// åˆ¤æ–­ä»·æ ¼æ˜¯ä¸æ˜¯å¤šä½æµ®ç‚¹æ•°
  								if (resp[i].price % 1 != 0){
  									// è¯´æ˜æ˜¯æµ®ç‚¹æ•°
  									resp[i].price = resp[i].price.toFixed(1)
  								}
  								self.items.push(resp[i]);
  								self.load_imgs.push(resp[i].numiid);
  							}

  							self.$nextTick(function(){
              					this.check_img_show();
            				});
  						},
  						error:function(error){
  							self.call_api_right_now = false;
  							self.request_api_wrong = true;
  							if (self.items.length > 0){
  								self.msg = 'ğŸ˜³æ²¡æœ‰æ›´å¤šäº†';
  							}else {
  								self.msg = 'ğŸ˜¢å•¥ä¹Ÿæ²¡æ‰¾åˆ°';
  							}
  						}
  					})

  				},

  				click_search_button:function(){
  					var input = document.getElementById("search-input");
					input.blur();

  					if (this.search_keyword.length > 0 && this.call_api_right_now == false ){
  						this.call_api_right_now = true;
  						// æ¸…ç©ºä¸Šä¸€æ¬¡çš„è¯·æ±‚æ•°æ®å’ŒçŠ¶æ€
  						this.items = [];
  						this.load_imgs = [];
  						this.next_page_num = 0;
  						this.aleady_load_imgs = [];
  						this.request_api_wrong = false;
  						this.get_search_data();
  					}
  				},

  				check_img_show:function(){
  					for (var i = 0; i < this.load_imgs.length; i++){
          				// é¦–å…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯åŠ è½½è¿‡äº†
          				if (this.aleady_load_imgs.indexOf(this.load_imgs[i]) == -1){
            				var id = '#{}'.format(this.load_imgs[i]);
            				var offset = $(id).offset();
            				var top_offset = offset.top;
            				var screenHeight = window.innerHeight;
            				var scrollTop = document.body.scrollTop;

            				var offset_height = top_offset - scrollTop;

            				// å¦‚æœåœ¨å¯è§†åŒºåŸŸå†…
            				if (offset_height < screenHeight){
              					$(id).attr('src',$(id).attr('data-src'));
              					this.aleady_load_imgs.push(this.load_imgs[i]);
           					 }
          				}
          			}
  				},

  				scroll_callback:function(){
  					// è·å–ä½ç½®å˜é‡
        			var screenHeight = window.innerHeight;
        			var bodyHeight = document.body.scrollHeight;
        			var scrollTop = document.body.scrollTop;
        			var leve = bodyHeight *0.8; 

        			if (screenHeight + scrollTop >= leve && this.request_api_wrong != true){
          				if (this.call_api_right_now == false){
            				this.call_api_right_now = true;
            				this.get_search_data();
          				}
        			}
        			this.check_img_show();
  				},

  				add_scroll_event:function(){
  					window.addEventListener('scroll',this.scroll_callback);
  				},

          recommend_button_click : function(name){
            // æ¸…ç©ºå½“å‰çš„è¯·æ±‚æ•°æ®
            this.items = [];
            this.load_imgs = [];
            this.next_page_num = 0;
            this.aleady_load_imgs = [];
            this.request_api_wrong = false;
            // èµ‹å€¼search_keyword
            this.search_keyword = name;
            this.get_search_data();
          },
  			},

  			ready : function(){
  				this.add_scroll_event();
  			}
  		});

	</script>
	
</body>
{% endverbatim %}
</html>